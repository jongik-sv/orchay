# 통합설계: WP-02 실시간 통신 검증

**Template Version:** 1.0.0 — **Last Updated:** 2026-01-02

> **설계 규칙**
> * 기능 중심 설계에 집중
> * 구현 코드 포함 금지
> * PRD/TRD와 일관성 유지

---

## 0. 문서 메타데이터

| 항목 | 내용 |
|------|------|
| Task ID | TSK-02-03 |
| Task명 | WP-02 통합 확인: 실시간 통신 검증 |
| Category | development |
| Domain | test |
| 상태 | [dd] 상세설계 |
| 작성일 | 2026-01-02 |
| 작성자 | AI Agent |

### 상위 문서 참조

| 문서 유형 | 경로 | 참조 섹션 |
|----------|------|----------|
| PRD | `.orchay/projects/table-order/prd.md` | 섹션 5 WebSocket 이벤트, 섹션 3.1 C-031, 섹션 3.2 K-001~K-002 |
| WBS | `.orchay/projects/table-order/wbs.yaml` | WP-02 |

### 선행 Task 참조

| Task ID | 제목 | 주요 산출물 |
|---------|------|------------|
| TSK-02-01 | Socket.io 서버 설정 및 Custom Server 구성 | server.ts, Socket.io 서버 인스턴스, 룸 기반 이벤트 핸들러 |
| TSK-02-02 | 실시간 이벤트 송수신 구현 | order:new, order:status 이벤트, lib/socket.ts 클라이언트 유틸 |

---

## 1. 목적 및 범위

### 1.1 목적

WP-02 (실시간 통신) 구현 결과를 통합 검증하여 WebSocket 기반 실시간 통신이 정상적으로 동작하는지 확인한다.

- Socket.io 서버 연결/해제 동작 검증
- 룸(table:{id}, kitchen) 기반 이벤트 라우팅 확인
- 주문 생성 → 주방 알림, 상태 변경 → 고객 알림 흐름 검증
- 재연결 시 기존 룸 복원 동작 확인

### 1.2 범위

**포함 범위**:
- WebSocket 연결/해제 테스트
- 룸 조인/리브 동작 확인
- order:new 이벤트 송수신 테스트
- order:status 이벤트 송수신 테스트
- 재연결 시 룸 복원 테스트

**제외 범위**:
- UI 컴포넌트 테스트 → TSK-03-04, TSK-04-03
- API 엔드포인트 테스트 → TSK-01-04
- E2E 전체 플로우 테스트 → TSK-05-01

---

## 2. 요구사항 분석

### 2.1 테스트 요구사항

| ID | 요구사항 | 우선순위 | PRD 참조 |
|----|----------|----------|----------|
| TR-001 | 클라이언트 연결 시 서버 로그 출력 확인 | High | TRD 섹션 5 |
| TR-002 | table:{id} 룸 조인 동작 확인 | High | PRD 섹션 5 |
| TR-003 | kitchen 룸 조인 동작 확인 | High | PRD 섹션 5 |
| TR-004 | order:new 이벤트가 kitchen 룸에만 전달되는지 확인 | Critical | PRD C-031, K-001 |
| TR-005 | order:status 이벤트가 해당 테이블 룸에만 전달되는지 확인 | Critical | PRD C-031 |
| TR-006 | 재연결 시 기존 룸 자동 복원 확인 | Medium | TSK-02-02 수용기준 |

### 2.2 비기능 요구사항

| ID | 요구사항 | 기준 | 측정 방법 |
|----|----------|------|----------|
| NFR-001 | WebSocket 연결 응답 시간 | < 1초 | Socket.io 연결 시 `performance.now()` 시작/종료 시점 차이 측정 |
| NFR-002 | 이벤트 전달 지연 | < 500ms | 이벤트 발송 타임스탬프와 클라이언트 수신 타임스탬프 차이 계산 |
| NFR-003 | 재연결 성공률 | 100% (5회 시도 기준) | 의도적 연결 해제 후 재연결 시도 횟수 및 성공 여부 로깅 |

---

## 3. 테스트 시나리오

### 3.1 연결/해제 테스트

**시나리오 1: 클라이언트 연결**
1. 클라이언트에서 Socket.io 연결 시도
2. 서버에서 연결 로그 출력 확인
3. 클라이언트에서 `connect` 이벤트 수신 확인

**시나리오 2: 클라이언트 해제**
1. 클라이언트에서 disconnect() 호출
2. 서버에서 해제 로그 출력 확인
3. 클라이언트에서 `disconnect` 이벤트 수신 확인

### 3.2 룸 조인/리브 테스트

**시나리오 3: 테이블 룸 조인**
1. 클라이언트에서 `join:table` 이벤트 송신 (tableId: 5)
2. 서버에서 `table:5` 룸에 소켓 추가 확인
3. 서버에서 룸 조인 로그 출력 확인

**시나리오 4: 주방 룸 조인**
1. 클라이언트에서 `join:kitchen` 이벤트 송신
2. 서버에서 `kitchen` 룸에 소켓 추가 확인
3. 서버에서 룸 조인 로그 출력 확인

### 3.3 이벤트 송수신 테스트

**시나리오 5: 새 주문 이벤트 (order:new)**
1. 테이블 5에서 주문 생성 (POST /api/orders)
2. 서버에서 `order:new` 이벤트를 `kitchen` 룸에 브로드캐스트
3. kitchen 룸에 조인한 클라이언트만 이벤트 수신 확인
4. 테이블 룸에 조인한 클라이언트는 이벤트 미수신 확인

**시나리오 6: 주문 상태 변경 이벤트 (order:status)**
1. 주방에서 주문 상태 변경 (PATCH /api/orders/{id}/status)
2. 서버에서 `order:status` 이벤트를 해당 `table:{id}` 룸에 브로드캐스트
3. 해당 테이블 룸에 조인한 클라이언트만 이벤트 수신 확인
4. 다른 테이블 룸 클라이언트는 이벤트 미수신 확인

### 3.4 재연결 테스트

**시나리오 7: 연결 복원**
1. 클라이언트 연결 후 table:5 룸 조인
2. 네트워크 연결 강제 해제
3. 네트워크 복원 후 자동 재연결 확인
4. 재연결 후 table:5 룸 자동 복원 확인

---

## 4. 테스트 방법

### 4.1 테스트 환경

| 구성요소 | 설정 |
|----------|------|
| 서버 | npm run dev (Custom Server) |
| 클라이언트 | 브라우저 콘솔 또는 테스트 스크립트 |
| 네트워크 | localhost:3000 |

### 4.2 테스트 도구

| 도구 | 용도 |
|------|------|
| vitest + socket.io-client | 자동화 통합 테스트 |
| 브라우저 개발자 도구 | WebSocket 연결 상태, 이벤트 모니터링 (수동 확인용) |
| 서버 콘솔 로그 | 연결/해제, 룸 조인/리브 로그 확인 |
| curl/httpie | API 호출로 이벤트 트리거 |

### 4.3 자동화 테스트 구성

**테스트 파일 위치**: `tests/integration/websocket.test.ts`

**테스트 설계**:
| 테스트 그룹 | 테스트 케이스 |
|------------|--------------|
| 연결/해제 | 클라이언트 연결, 해제, 서버 로그 확인 |
| 룸 관리 | table:{id} 조인, kitchen 조인 |
| 이벤트 송수신 | order:new 브로드캐스트, order:status 브로드캐스트 |
| 이벤트 격리 | 다른 룸 클라이언트 미수신 확인 |
| 재연결 | 연결 복원 시 룸 자동 조인 |

**테스트 환경 설정**:
- beforeAll: 테스트 서버 시작, Socket.io 클라이언트 초기화
- afterAll: 모든 연결 해제, 서버 정리
- 각 테스트: 독립적인 소켓 인스턴스 사용

### 4.4 테스트 절차

1. **사전 조건**
   - TSK-02-01, TSK-02-02 구현 완료
   - npm run dev로 서버 실행

2. **테스트 실행**
   - 브라우저 2개 탭 오픈
   - 탭1: /order?table=5 (고객 화면)
   - 탭2: /kitchen (주방 화면)
   - 각 시나리오별 테스트 수행

3. **결과 검증**
   - 서버 콘솔 로그 확인
   - 브라우저 콘솔 이벤트 확인
   - UI 실시간 업데이트 확인

---

## 5. 인수 기준

### WBS 기반 인수 기준

- [ ] AC-01: 클라이언트 연결 시 서버 로그 출력
- [ ] AC-02: table:{id} 룸 조인 동작
- [ ] AC-03: kitchen 룸 조인 동작
- [ ] AC-04: order:new 이벤트 주방에 전달
- [ ] AC-05: order:status 이벤트 고객에 전달
- [ ] AC-06: 재연결 시 기존 룸 복원

### 추가 검증 항목

- [ ] AC-07: 이벤트가 지정된 룸에만 전달 (격리 확인)
- [ ] AC-08: 여러 클라이언트 동시 연결 시 정상 동작

---

## 6. 리스크 및 의존성

### 6.1 리스크

| 리스크 | 영향 | 완화 방안 |
|--------|------|----------|
| TSK-02-01/02 미완료 시 테스트 불가 | High | 선행 Task 완료 후 진행 |
| 네트워크 불안정 시 재연결 테스트 실패 | Medium | 로컬 환경에서 테스트 |
| 브라우저별 WebSocket 동작 차이 | Low | Chrome 기준 테스트 |

### 6.2 의존성

| 의존 대상 | 유형 | 설명 |
|----------|------|------|
| TSK-02-01 | 선행 | Socket.io 서버 설정 |
| TSK-02-02 | 선행 | 이벤트 송수신 구현 |
| TSK-01-03 | 참조 | 주문 API (이벤트 트리거) |

---

## 7. 테스트 결과 템플릿

```markdown
### 테스트 결과 요약

| 시나리오 | 결과 | 비고 |
|----------|------|------|
| 연결 테스트 | PASS/FAIL | |
| 해제 테스트 | PASS/FAIL | |
| 테이블 룸 조인 | PASS/FAIL | |
| 주방 룸 조인 | PASS/FAIL | |
| order:new 이벤트 | PASS/FAIL | |
| order:status 이벤트 | PASS/FAIL | |
| 재연결 복원 | PASS/FAIL | |

### 발견된 이슈

| 이슈 | 심각도 | 상태 |
|------|--------|------|
| | | |
```

---

## 8. 다음 단계

- `/wf:build` 명령어로 테스트 실행 및 결과 기록 진행

---

## 관련 문서

- PRD: `.orchay/projects/table-order/prd.md`
- TSK-02-01 설계: `.orchay/projects/table-order/tasks/TSK-02-01/010-design.md`
- TSK-02-02 설계: `.orchay/projects/table-order/tasks/TSK-02-02/010-design.md`
- 상세설계: `020-detail-design.md` (다음 단계)

---

<!--
author: AI Agent
Template Version: 1.0.0
-->
