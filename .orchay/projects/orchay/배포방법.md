# orchay 배포 방법

## 개요

orchay Python 프로젝트를 단일 실행 파일로 배포하는 방법을 설명합니다.

---

## 의존성 정보

```toml
dependencies = [
    "textual>=1.0",
    "rich>=14.0",
    "watchdog>=4.0",
    "pydantic>=2.0",
]
```

---

## 배포 옵션 비교

| 방식 | 파일 크기 | Python 필요 | 시작 속도 | 빌드 시간 |
|------|----------|------------|----------|----------|
| PyInstaller | ~80MB | 불필요 | 보통 | 빠름 |
| Nuitka | ~40MB | 불필요 | 빠름 | 느림 |
| Shiv | ~5MB | 필요 | 빠름 | 빠름 |

---

## 1. PyInstaller (권장)

가장 널리 사용되며 Textual과 호환됩니다.

### 설치

```bash
cd orchay
uv pip install pyinstaller
```

### 빌드

```bash
# 단일 실행 파일 생성
pyinstaller --onefile --name orchay src/orchay/__main__.py

# 아이콘 포함 (Windows)
pyinstaller --onefile --name orchay --icon=orchay.ico src/orchay/__main__.py

# 결과: dist/orchay.exe (Windows) 또는 dist/orchay (Unix)
```

### 장점
- 간단한 사용법
- Windows/macOS/Linux 모두 지원
- Python 설치 불필요

### 단점
- 파일 크기가 큼 (50-100MB)
- 첫 실행 시 압축 해제로 시작 시간 느림

---

## 2. Nuitka (성능 최적화)

Python을 C로 컴파일하여 더 빠른 실행 파일을 생성합니다.

### 설치

```bash
cd orchay
uv pip install nuitka

# Windows: Visual Studio Build Tools 또는 MinGW 필요
# Linux: gcc 필요
# macOS: Xcode Command Line Tools 필요
```

### 빌드

```bash
# 단일 실행 파일 생성
nuitka --standalone --onefile --output-filename=orchay src/orchay/__main__.py

# 추가 최적화 옵션
nuitka --standalone --onefile \
    --output-filename=orchay \
    --enable-plugin=anti-bloat \
    --nofollow-import-to=pytest \
    src/orchay/__main__.py
```

### 장점
- 빠른 실행 속도 (네이티브 컴파일)
- 상대적으로 작은 파일 크기
- 코드 보호 (역공학 어려움)

### 단점
- 컴파일 시간이 오래 걸림 (10-30분)
- C 컴파일러 필요

---

## 3. Shiv (zipapp 방식)

Python이 설치된 환경에서만 동작하지만 가볍습니다.

### 설치

```bash
cd orchay
uv pip install shiv
```

### 빌드

```bash
# pyz 파일 생성
shiv -c orchay -o orchay.pyz .

# 또는 wheel에서 생성
uv build
shiv -c orchay -o orchay.pyz dist/orchay-0.1.0-py3-none-any.whl
```

### 실행

```bash
# Python 3.10+ 필요
python orchay.pyz

# 또는 Unix에서 직접 실행 (shebang 포함)
./orchay.pyz
```

### 장점
- 매우 작은 파일 크기 (수 MB)
- 빠른 빌드 시간
- 빠른 시작 속도

### 단점
- 대상 시스템에 Python 3.10+ 필요
- 의존성 버전 충돌 가능성

---

## 4. 빌드 스크립트 예시

### build.py

```python
#!/usr/bin/env python3
"""orchay 빌드 스크립트"""

import subprocess
import sys
from pathlib import Path

def build_pyinstaller():
    """PyInstaller로 빌드"""
    cmd = [
        sys.executable, "-m", "PyInstaller",
        "--onefile",
        "--name", "orchay",
        "--clean",
        "src/orchay/__main__.py"
    ]
    subprocess.run(cmd, check=True)
    print("빌드 완료: dist/orchay")

def build_nuitka():
    """Nuitka로 빌드"""
    cmd = [
        sys.executable, "-m", "nuitka",
        "--standalone",
        "--onefile",
        "--output-filename=orchay",
        "src/orchay/__main__.py"
    ]
    subprocess.run(cmd, check=True)
    print("빌드 완료: orchay")

if __name__ == "__main__":
    method = sys.argv[1] if len(sys.argv) > 1 else "pyinstaller"

    if method == "pyinstaller":
        build_pyinstaller()
    elif method == "nuitka":
        build_nuitka()
    else:
        print(f"Unknown method: {method}")
        sys.exit(1)
```

### 사용법

```bash
# PyInstaller 빌드
python build.py pyinstaller

# Nuitka 빌드
python build.py nuitka
```

---

## 5. pyproject.toml 설정

빌드 의존성을 추가합니다:

```toml
[project.optional-dependencies]
dev = [
    "pytest>=8.0",
    "pytest-asyncio>=0.23",
    "ruff>=0.5",
    "pyright>=1.1",
]
build = [
    "pyinstaller>=6.0",
]
```

설치:

```bash
uv pip install -e ".[build]"
```

---

## 6. 배포 체크리스트

- [ ] 버전 번호 업데이트 (pyproject.toml)
- [ ] 테스트 통과 확인
- [ ] 빌드 실행
- [ ] 생성된 실행 파일 테스트
- [ ] README 업데이트
- [ ] 릴리스 노트 작성
- [ ] GitHub Release 생성 (선택)

---

## 7. 플랫폼별 빌드

각 플랫폼에서 별도로 빌드해야 합니다:

| 플랫폼 | 빌드 환경 | 결과물 |
|--------|----------|--------|
| Windows | Windows 10/11 | `orchay.exe` |
| macOS | macOS 12+ | `orchay` (Universal Binary 권장) |
| Linux | Ubuntu 20.04+ | `orchay` |

### GitHub Actions 예시

```yaml
name: Build

on:
  release:
    types: [created]

jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install uv
          uv pip install -e ".[build]"

      - name: Build
        run: pyinstaller --onefile --name orchay src/orchay/__main__.py

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: orchay-${{ matrix.os }}
          path: dist/orchay*
```

---

## 8. 설정 파일 함께 배포하기

orchay 실행 파일과 함께 hook, .wezterm.lua, .orchay 설정 파일들을 배포하는 방법입니다.

### 8.1 배포 대상 설정 파일

| 파일 | 용도 | 필수 |
|------|------|------|
| `.orchay/settings/columns.json` | 칸반 컬럼 정의 | 필수 |
| `.orchay/settings/workflows.json` | 워크플로우 상태 머신 | 필수 |
| `.wezterm.lua` | WezTerm 4분할 레이아웃 | 권장 |
| `.claude/settings.json` | Claude Code 권한 설정 | 권장 |

### 8.2 추천 전략: 하이브리드 방식

**핵심 아이디어:**
1. 기본 설정을 실행 파일에 임베드
2. `orchay init` 명령어로 프로젝트 초기화
3. 선택적 WezTerm/Claude 설정 설치

### 8.3 구현 계획

#### Phase 1: 기본 설정 임베드

**신규 폴더 구조:**
```
orchay/src/orchay/data/
├── columns.json          # .orchay/settings/columns.json 복사
├── workflows.json        # .orchay/settings/workflows.json 복사
├── wezterm.lua           # .orchay/docs/.wezterm.lua 복사
└── claude-settings.json  # .claude/settings.json 복사
```

**신규 파일: `defaults.py`**
```python
# orchay/src/orchay/defaults.py
import json
from importlib import resources

def get_default_columns() -> dict:
    """임베드된 columns.json 로드"""
    with resources.files("orchay.data").joinpath("columns.json").open() as f:
        return json.load(f)

def get_default_workflows() -> dict:
    """임베드된 workflows.json 로드"""
    with resources.files("orchay.data").joinpath("workflows.json").open() as f:
        return json.load(f)

def get_wezterm_config() -> str:
    """임베드된 wezterm.lua 로드"""
    return resources.files("orchay.data").joinpath("wezterm.lua").read_text()

def get_claude_settings() -> dict:
    """임베드된 claude-settings.json 로드"""
    with resources.files("orchay.data").joinpath("claude-settings.json").open() as f:
        return json.load(f)
```

#### Phase 2: `orchay init` 명령어

**CLI 사용법:**
```bash
# 기본 초기화 (필수 설정만)
orchay init <project-name>

# 모든 설정 포함
orchay init <project-name> --all

# 옵션 선택
orchay init <project-name> --wezterm --claude

# 기존 설정 덮어쓰기
orchay init <project-name> --force
```

**옵션 설명:**
| 옵션 | 설명 |
|------|------|
| `--force, -f` | 기존 설정 덮어쓰기 (백업 생성) |
| `--wezterm` | WezTerm 설정 설치 (`~/.wezterm.lua`) |
| `--claude` | Claude 설정 설치 (`.claude/settings.json`) |
| `--all` | 모든 설정 설치 |

**구현 코드:**
```python
# orchay/src/orchay/cli.py
import typer
from pathlib import Path
from datetime import datetime
from .defaults import (
    get_default_columns,
    get_default_workflows,
    get_wezterm_config,
    get_claude_settings,
)

app = typer.Typer()

@app.command()
def init(
    project: str = typer.Argument(..., help="프로젝트명"),
    force: bool = typer.Option(False, "--force", "-f", help="기존 설정 덮어쓰기"),
    wezterm: bool = typer.Option(False, "--wezterm", help="WezTerm 설정 설치"),
    claude: bool = typer.Option(False, "--claude", help="Claude 설정 설치"),
    all_configs: bool = typer.Option(False, "--all", help="모든 설정 설치"),
):
    """프로젝트 초기화 - .orchay 구조 및 설정 파일 생성"""

    base_dir = Path.cwd()

    # 1. .orchay 디렉토리 구조 생성
    orchay_dir = base_dir / ".orchay"
    settings_dir = orchay_dir / "settings"
    projects_dir = orchay_dir / "projects" / project

    settings_dir.mkdir(parents=True, exist_ok=True)
    projects_dir.mkdir(parents=True, exist_ok=True)

    # 2. 필수 설정 파일 복사
    _copy_config(settings_dir / "columns.json", get_default_columns(), force)
    _copy_config(settings_dir / "workflows.json", get_default_workflows(), force)

    # 3. WBS 템플릿 생성
    wbs_path = projects_dir / "wbs.md"
    if not wbs_path.exists() or force:
        wbs_path.write_text(_get_wbs_template(project), encoding="utf-8")
        typer.echo(f"Created: {wbs_path}")

    # 4. WezTerm 설정 (선택적)
    if wezterm or all_configs:
        _install_wezterm(force)

    # 5. Claude 설정 (선택적)
    if claude or all_configs:
        _install_claude_settings(base_dir, force)

    typer.echo(f"\n✅ Project '{project}' initialized successfully!")
    typer.echo(f"   Run: orchay {project}")


def _copy_config(path: Path, content: dict, force: bool) -> None:
    """설정 파일 복사 (백업 포함)"""
    import json

    if path.exists() and not force:
        typer.echo(f"Skipped (exists): {path}")
        return

    if path.exists() and force:
        backup = path.with_suffix(f".{datetime.now():%Y%m%d_%H%M%S}.bak")
        path.rename(backup)
        typer.echo(f"Backup: {backup}")

    with open(path, "w", encoding="utf-8") as f:
        json.dump(content, f, indent=2, ensure_ascii=False)
    typer.echo(f"Created: {path}")


def _install_wezterm(force: bool) -> None:
    """WezTerm 설정 설치"""
    target = Path.home() / ".wezterm.lua"

    if target.exists() and not force:
        typer.echo(f"Skipped (exists): {target}")
        typer.echo("  Use --force to overwrite (backup will be created)")
        return

    if target.exists():
        backup = target.with_suffix(f".{datetime.now():%Y%m%d}.bak.lua")
        target.rename(backup)
        typer.echo(f"Backup: {backup}")

    target.write_text(get_wezterm_config(), encoding="utf-8")
    typer.echo(f"Created: {target}")


def _install_claude_settings(base_dir: Path, force: bool) -> None:
    """Claude 설정 설치"""
    import json

    claude_dir = base_dir / ".claude"
    claude_dir.mkdir(exist_ok=True)
    target = claude_dir / "settings.json"

    if target.exists() and not force:
        typer.echo(f"Skipped (exists): {target}")
        return

    if target.exists():
        backup = target.with_suffix(f".{datetime.now():%Y%m%d_%H%M%S}.bak")
        target.rename(backup)
        typer.echo(f"Backup: {backup}")

    with open(target, "w", encoding="utf-8") as f:
        json.dump(get_claude_settings(), f, indent=2)
    typer.echo(f"Created: {target}")


def _get_wbs_template(project: str) -> str:
    """WBS 템플릿 반환"""
    return f'''# WBS - {project}

> version: 1.0
> depth: 3
> updated: {datetime.now():%Y-%m-%d}
> project-root: .

---

## WP-01: 초기 설정
- status: planned
- priority: high

### TSK-01-01: 프로젝트 구조 설정
- category: infrastructure
- domain: infra
- status: [ ]
- priority: high
- assignee: -

#### PRD 요구사항
- requirements:
  - 프로젝트 초기 설정

---
'''
```

#### Phase 3: ConfigManager 클래스

**신규 파일: `config_manager.py`**
```python
# orchay/src/orchay/config_manager.py
import json
import shutil
from pathlib import Path
from datetime import datetime
from typing import Optional
from rich.console import Console

from .defaults import get_default_columns, get_default_workflows

console = Console()


class ConfigManager:
    """설정 파일 관리자"""

    def __init__(self, base_dir: Path):
        self.base_dir = base_dir
        self.orchay_dir = base_dir / ".orchay"
        self.settings_dir = self.orchay_dir / "settings"

    def ensure_settings(self) -> tuple[Path, Path]:
        """필수 설정 파일 확인 및 생성"""
        self.settings_dir.mkdir(parents=True, exist_ok=True)

        columns_path = self.settings_dir / "columns.json"
        workflows_path = self.settings_dir / "workflows.json"

        if not columns_path.exists():
            self._create_default(columns_path, get_default_columns())
            console.print(f"[yellow]Created:[/] {columns_path}")

        if not workflows_path.exists():
            self._create_default(workflows_path, get_default_workflows())
            console.print(f"[yellow]Created:[/] {workflows_path}")

        return columns_path, workflows_path

    def _create_default(self, path: Path, content: dict) -> None:
        """기본 설정 파일 생성"""
        with open(path, "w", encoding="utf-8") as f:
            json.dump(content, f, indent=2, ensure_ascii=False)

    def backup_and_update(self, target: Path, new_content: dict) -> None:
        """기존 파일 백업 후 업데이트"""
        if target.exists():
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            backup = target.with_suffix(f".{timestamp}.bak")
            shutil.copy(target, backup)
            console.print(f"[dim]Backup:[/] {backup}")

        with open(target, "w", encoding="utf-8") as f:
            json.dump(new_content, f, indent=2, ensure_ascii=False)
        console.print(f"[green]Updated:[/] {target}")

    def get_config_version(self, path: Path) -> Optional[str]:
        """설정 파일 버전 확인"""
        if not path.exists():
            return None

        try:
            with open(path, "r", encoding="utf-8") as f:
                data = json.load(f)
            return data.get("version")
        except (json.JSONDecodeError, KeyError):
            return None
```

#### Phase 4: PyInstaller 빌드 설정

**pyproject.toml 수정:**
```toml
[tool.hatch.build.targets.wheel]
packages = ["src/orchay"]

# 데이터 파일 포함
[tool.hatch.build.targets.wheel.shared-data]
"src/orchay/data" = "orchay/data"
```

**orchay.spec (PyInstaller 전용):**
```python
# -*- mode: python ; coding: utf-8 -*-

a = Analysis(
    ['src/orchay/__main__.py'],
    pathex=[],
    binaries=[],
    datas=[
        ('src/orchay/data/columns.json', 'orchay/data'),
        ('src/orchay/data/workflows.json', 'orchay/data'),
        ('src/orchay/data/wezterm.lua', 'orchay/data'),
        ('src/orchay/data/claude-settings.json', 'orchay/data'),
    ],
    hiddenimports=['orchay.data'],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[],
    noarchive=False,
)

pyz = PYZ(a.pure)

exe = EXE(
    pyz,
    a.scripts,
    a.binaries,
    a.datas,
    [],
    name='orchay',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=True,
    console=True,
)
```

### 8.4 배포 아티팩트 구조

```
GitHub Releases/
├── orchay-v0.1.0-windows-x64.zip
│   ├── orchay.exe              # 설정 파일 임베드됨
│   └── README.md
│
├── orchay-v0.1.0-linux-x64.tar.gz
│   ├── orchay
│   └── README.md
│
├── orchay-v0.1.0-macos-x64.tar.gz
│   ├── orchay
│   └── README.md
│
└── orchay-v0.1.0-config-only.zip  # 설정 파일만 (선택)
    ├── .orchay/
    │   └── settings/
    │       ├── columns.json
    │       └── workflows.json
    ├── .wezterm.lua
    └── .claude/
        └── settings.json
```

### 8.5 사용자 워크플로우

```bash
# 1. orchay 다운로드 및 PATH 추가
# Windows: orchay.exe를 C:\tools\에 복사
# Unix: /usr/local/bin/에 복사

# 2. 프로젝트 디렉토리로 이동
cd my-project

# 3. 초기화 (필수 설정 + WezTerm + Claude)
orchay init my-project --all

# 4. 생성된 파일 확인
# .orchay/settings/columns.json
# .orchay/settings/workflows.json
# .orchay/projects/my-project/wbs.md
# ~/.wezterm.lua
# .claude/settings.json

# 5. WBS 파일 수정 후 실행
orchay my-project
```

### 8.6 파일 변경 목록

| 작업 | 파일 |
|------|------|
| 신규 | `orchay/src/orchay/data/columns.json` |
| 신규 | `orchay/src/orchay/data/workflows.json` |
| 신규 | `orchay/src/orchay/data/wezterm.lua` |
| 신규 | `orchay/src/orchay/data/claude-settings.json` |
| 신규 | `orchay/src/orchay/defaults.py` |
| 신규 | `orchay/src/orchay/config_manager.py` |
| 수정 | `orchay/src/orchay/cli.py` - init 명령어 추가 |
| 수정 | `orchay/pyproject.toml` - package_data 추가 |
| 신규 | `orchay/orchay.spec` - PyInstaller 빌드 설정 |

### 8.7 구현 우선순위

1. **data/ 폴더 생성 및 설정 파일 복사** (필수)
2. **defaults.py - 리소스 로드 함수** (필수)
3. **config_manager.py - 설정 관리 클래스** (필수)
4. **cli.py - init 명령어 추가** (필수)
5. **pyproject.toml - package_data 설정** (필수)
6. **orchay.spec - PyInstaller 빌드 설정** (배포 시)

---

## 참고 자료

- [PyInstaller 문서](https://pyinstaller.org/)
- [Nuitka 문서](https://nuitka.net/)
- [Shiv 문서](https://github.com/linkedin/shiv)
- [Textual 배포 가이드](https://textual.textualize.io/)
- [importlib.resources 문서](https://docs.python.org/3/library/importlib.resources.html)
